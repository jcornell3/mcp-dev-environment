version: '3.8'

services:
  # ============================================================================
  # CORE MCP SERVERS (Accessed via HTTP/SSE Bridge layer)
  # ============================================================================

  math:
    build: ./servers/math
    stdin_open: true
    tty: false
    restart: "no"
    environment:
      - MCP_API_KEY=${MCP_API_KEY:-default-api-key}

  santa-clara:
    build: ./servers/santa-clara
    stdin_open: true
    tty: false
    restart: "no"
    environment:
      - MCP_API_KEY=${MCP_API_KEY:-default-api-key}

  youtube-transcript:
    build: ./servers/youtube-transcript
    stdin_open: true
    tty: false
    restart: "no"
    environment:
      - MCP_API_KEY=${MCP_API_KEY:-default-api-key}

  youtube-to-mp3:
    build: ./servers/youtube-to-mp3
    stdin_open: true
    tty: false
    restart: "no"
    environment:
      - DOWNLOADS_DIR=/app/downloads
      - MCP_API_KEY=${MCP_API_KEY:-default-api-key}
    volumes:
      - ${DOWNLOADS_DIR:-/mnt/c/Users/jcorn/Downloads}:/app/downloads

  github-remote:
    build: ./servers/github-remote
    stdin_open: true
    tty: false
    restart: "no"
    environment:
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN:-}
      - MCP_API_KEY=${MCP_API_KEY:-default-api-key}

  # ============================================================================
  # BRIDGE SERVERS (HTTP/SSE - Expose on ports 3001-3005 for Claude Desktop)
  # ============================================================================

  bridge-math:
    build: ./servers/universal-cloud-connector-test
    ports:
      - "127.0.0.1:${BRIDGE_MATH_PORT:-3001}:3000"
    stdin_open: true
    tty: false
    restart: "no"
    depends_on:
      - math
    environment:
      - PORT=3000
      - API_TOKEN=${BRIDGE_API_TOKEN:-bridge-default-secret}
      - TARGET_SERVER=math
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: node /app/real-test-bridge.js

  bridge-santa-clara:
    build: ./servers/universal-cloud-connector-test
    ports:
      - "127.0.0.1:${BRIDGE_SANTA_CLARA_PORT:-3002}:3000"
    stdin_open: true
    tty: false
    restart: "no"
    depends_on:
      - santa-clara
    environment:
      - PORT=3000
      - API_TOKEN=${BRIDGE_API_TOKEN:-bridge-default-secret}
      - TARGET_SERVER=santa-clara
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: node /app/real-test-bridge.js

  bridge-youtube-transcript:
    build: ./servers/universal-cloud-connector-test
    ports:
      - "127.0.0.1:${BRIDGE_YOUTUBE_TRANSCRIPT_PORT:-3003}:3000"
    stdin_open: true
    tty: false
    restart: "no"
    depends_on:
      - youtube-transcript
    environment:
      - PORT=3000
      - API_TOKEN=${BRIDGE_API_TOKEN:-bridge-default-secret}
      - TARGET_SERVER=youtube-transcript
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: node /app/real-test-bridge.js

  bridge-youtube-to-mp3:
    build: ./servers/universal-cloud-connector-test
    ports:
      - "127.0.0.1:${BRIDGE_YOUTUBE_TO_MP3_PORT:-3004}:3000"
    stdin_open: true
    tty: false
    restart: "no"
    depends_on:
      - youtube-to-mp3
    environment:
      - PORT=3000
      - API_TOKEN=${BRIDGE_API_TOKEN:-bridge-default-secret}
      - TARGET_SERVER=youtube-to-mp3
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: node /app/real-test-bridge.js

  bridge-github-remote:
    build: ./servers/universal-cloud-connector-test
    ports:
      - "127.0.0.1:${BRIDGE_GITHUB_REMOTE_PORT:-3005}:3000"
    stdin_open: true
    tty: false
    restart: "no"
    depends_on:
      - github-remote
    environment:
      - PORT=3000
      - API_TOKEN=${BRIDGE_API_TOKEN:-bridge-default-secret}
      - TARGET_SERVER=github-remote
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: node /app/real-test-bridge.js

  # ============================================================================
  # CADDY REVERSE PROXY (Ingress Layer - Public 80/443, Internal routing)
  # ============================================================================

  caddy:
    image: caddy:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - ACME_AGREE=true
    restart: unless-stopped
    depends_on:
      - bridge-math
      - bridge-santa-clara
      - bridge-youtube-transcript
      - bridge-youtube-to-mp3
      - bridge-github-remote
    networks:
      - mcp-network

networks:
  mcp-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  caddy_data:
  caddy_config:
